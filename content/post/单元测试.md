+++
date = "2016-07-26T11:37:27+08:00"
draft = false
title = "单元测试"
image = "unit.jpg"

+++

> 总结一下在工作中做单元测试的经验

## 为什么要做测试？
先说一下，我们公司的大神是几乎不做测试的，所以情况因人而异。
我作为打工的，经常被问到“你写的对吗？”“你确定你的这个东西靠谱吗？”“为什么报错了，你刚才改的对吗？”
这样的问题。
而且我在工作中用的大多是JavaScript，一门动态语言。
为了消除问人质问时，自己内心的回响，也为了应对动态语言比静态语言更容易出错的问题，我就必须对自己的代码做测试。

## JS单元测试
所以，接下来我要记录一下我做JS单元测试的心得。
我其实一般不做真正的单元测试，我的测试对象一般分为3种：
1. 常用接口的测试。
比如有几个接口，不管代码怎么重构，这几个接口都会存在，那就对这些接口进行测试。
例：我有一个图片对象，这个对象总会有一个转成PNG的接口，那就对这个接口进行测试。
2. 无状态的函数
就是这些不取决于全局状态的函数，可以对这些函数进行测试，这个是比较单元测试的一种。
例：我有一个函数叫相加，参数是两个整数，返回两个数的和，那这种不取决于全局状态的函数就要测试一下。
3. 之前的错误
产品发布/提交代码之后发现了bug，为了让bug不再出现，写测试保证其不再出现。

## 开始测试
对于比较小的模块，或者用不了一两秒就可以完成的测试，又或者是只有同步代码的模块，我们
可以使用mocha来测试。  

大概代码如下：
```Javascript
describe('example mocha test', function () {
	it('should work just fine', function () {
		assert(true);
	});
});
```
这里我使用了node自带的assert模块，
你可以选mocha推荐的一些assert模块，不过我个人不会把测试弄得那么像英文课文。  

当我们为node服务器做测试时，就需要更有针对性的测试框架，而我选了AVA。
AVA的测试是并行的，而且使用了Babel，允许我使用Async函数来简化异步代码。
例：我们公司的node服务器有至少40个接口，其中查数据库的接口，
每个要耗时50~150毫秒查询，再加上传输的时间和其它一些工具函数的测试，最少也要花5秒
如果使用AVA并行运行测试的话，只需要2秒左右，而且测试代码会更优雅。  

大概代码如下：
```Javascript
import test from 'ava';

test('example ava test', async t => {
	await Promise.resolve(null);
	t.ok('look ma, I\'m async!');
});
```

根据项目和代码的情况，来选择相应的单元测试框架，是有一定学问的。我这里虽然只列举了两个，但不代表其它的就不好。  
比如karma和jasmine也是很好的选择。
但请允许我多说一句，如果你的测试超过了10秒，我推荐你试一试AVA，因为AVA会用process模块spawn测试，
这意味着你的电脑i5/i7的每个线程都会被利用到，这比其它的测试框架的那些语法糖都要有用的多。  

总之，不管是哪一个框架，单元测试都是必要的，不然你怎么知道你写的是对的呢？
